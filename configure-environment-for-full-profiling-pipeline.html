<!DOCTYPE html>
<html lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>Chapter 2 Configure Environment for Full Profiling Pipeline | Image-based Profiling Handbook</title>
  <meta name="description" content="This is a handbook for processing image-based profiling datasets using CellProfiler and cytominer" />
  <meta name="generator" content="bookdown 0.22.5 and GitBook 2.6.7" />

  <meta property="og:title" content="Chapter 2 Configure Environment for Full Profiling Pipeline | Image-based Profiling Handbook" />
  <meta property="og:type" content="book" />
  
  
  <meta property="og:description" content="This is a handbook for processing image-based profiling datasets using CellProfiler and cytominer" />
  <meta name="github-repo" content="rstudio/bookdown-demo" />

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="Chapter 2 Configure Environment for Full Profiling Pipeline | Image-based Profiling Handbook" />
  
  <meta name="twitter:description" content="This is a handbook for processing image-based profiling datasets using CellProfiler and cytominer" />
  

<meta name="author" content="Tim Becker, Beth Cimini, Shantanu Singh, Gregory Way, Hamdah Abbasi" />


<meta name="date" content="2021-06-25" />

  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  
<link rel="prev" href="introduction.html"/>
<link rel="next" href="setup-images.html"/>
<script src="libs/jquery-2.2.3/jquery.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-clipboard.css" rel="stylesheet" />









<link href="libs/anchor-sections-1.0.1/anchor-sections.css" rel="stylesheet" />
<script src="libs/anchor-sections-1.0.1/anchor-sections.js"></script>


<style type="text/css">
div.sourceCode { overflow-x: auto; }
table.sourceCode, tr.sourceCode, td.lineNumbers, td.sourceCode {
  margin: 0; padding: 0; vertical-align: baseline; border: none; }
table.sourceCode { width: 100%; line-height: 100%; }
td.lineNumbers { text-align: right; padding-right: 4px; padding-left: 4px; color: #aaaaaa; border-right: 1px solid #aaaaaa; }
td.sourceCode { padding-left: 5px; }
code > span.kw { color: #007020; font-weight: bold; } /* Keyword */
code > span.dt { color: #902000; } /* DataType */
code > span.dv { color: #40a070; } /* DecVal */
code > span.bn { color: #40a070; } /* BaseN */
code > span.fl { color: #40a070; } /* Float */
code > span.ch { color: #4070a0; } /* Char */
code > span.st { color: #4070a0; } /* String */
code > span.co { color: #60a0b0; font-style: italic; } /* Comment */
code > span.ot { color: #007020; } /* Other */
code > span.al { color: #ff0000; font-weight: bold; } /* Alert */
code > span.fu { color: #06287e; } /* Function */
code > span.er { color: #ff0000; font-weight: bold; } /* Error */
code > span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
code > span.cn { color: #880000; } /* Constant */
code > span.sc { color: #4070a0; } /* SpecialChar */
code > span.vs { color: #4070a0; } /* VerbatimString */
code > span.ss { color: #bb6688; } /* SpecialString */
code > span.im { } /* Import */
code > span.va { color: #19177c; } /* Variable */
code > span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code > span.op { color: #666666; } /* Operator */
code > span.bu { } /* BuiltIn */
code > span.ex { } /* Extension */
code > span.pp { color: #bc7a00; } /* Preprocessor */
code > span.at { color: #7d9029; } /* Attribute */
code > span.do { color: #ba2121; font-style: italic; } /* Documentation */
code > span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code > span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code > span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
</style>


<link rel="stylesheet" href="style.css" type="text/css" />
</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li><a href="./">Image-based Profiling Handbook</a></li>

<li class="divider"></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i>Preface</a></li>
<li class="chapter" data-level="1" data-path="introduction.html"><a href="introduction.html"><i class="fa fa-check"></i><b>1</b> Introduction</a><ul>
<li class="chapter" data-level="1.1" data-path="introduction.html"><a href="introduction.html#collect-your-software"><i class="fa fa-check"></i><b>1.1</b> Collect your software</a></li>
<li class="chapter" data-level="1.2" data-path="introduction.html"><a href="introduction.html#collect-your-pipelines"><i class="fa fa-check"></i><b>1.2</b> Collect your pipelines</a></li>
<li class="chapter" data-level="1.3" data-path="introduction.html"><a href="introduction.html#determine-how-to-get-your-image-lists-to-cellprofiler"><i class="fa fa-check"></i><b>1.3</b> Determine how to get your image lists to CellProfiler</a></li>
<li class="chapter" data-level="1.4" data-path="introduction.html"><a href="introduction.html#execute-your-cellprofiler-pipelines"><i class="fa fa-check"></i><b>1.4</b> Execute your CellProfiler pipelines</a><ul>
<li class="chapter" data-level="1.4.1" data-path="introduction.html"><a href="introduction.html#optional-z-projection"><i class="fa fa-check"></i><b>1.4.1</b> (Optional) Z projection</a></li>
<li class="chapter" data-level="1.4.2" data-path="introduction.html"><a href="introduction.html#optional-qc"><i class="fa fa-check"></i><b>1.4.2</b> (Optional) QC</a></li>
<li class="chapter" data-level="1.4.3" data-path="introduction.html"><a href="introduction.html#illumination-correction"><i class="fa fa-check"></i><b>1.4.3</b> Illumination correction</a></li>
<li class="chapter" data-level="1.4.4" data-path="introduction.html"><a href="introduction.html#optional-assay-development"><i class="fa fa-check"></i><b>1.4.4</b> (Optional) Assay Development</a></li>
</ul></li>
<li class="chapter" data-level="1.5" data-path="introduction.html"><a href="introduction.html#analysis"><i class="fa fa-check"></i><b>1.5</b> Analysis</a></li>
<li class="chapter" data-level="1.6" data-path="introduction.html"><a href="introduction.html#aggregate-your-data"><i class="fa fa-check"></i><b>1.6</b> Aggregate your data</a></li>
<li class="chapter" data-level="1.7" data-path="introduction.html"><a href="introduction.html#create-and-manipulate-per-well-profiles."><i class="fa fa-check"></i><b>1.7</b> Create and manipulate per-well profiles.</a></li>
</ul></li>
<li class="part"><span><b>I Configuration</b></span></li>
<li class="chapter" data-level="2" data-path="configure-environment-for-full-profiling-pipeline.html"><a href="configure-environment-for-full-profiling-pipeline.html"><i class="fa fa-check"></i><b>2</b> Configure Environment for Full Profiling Pipeline</a><ul>
<li class="chapter" data-level="2.1" data-path="configure-environment-for-full-profiling-pipeline.html"><a href="configure-environment-for-full-profiling-pipeline.html#launch-an-aws-virtual-machine-for-making-csvs-and-running-distributed-cellprofiler"><i class="fa fa-check"></i><b>2.1</b> Launch an AWS Virtual Machine for making CSVs and running Distributed-CellProfiler</a></li>
<li class="chapter" data-level="2.2" data-path="configure-environment-for-full-profiling-pipeline.html"><a href="configure-environment-for-full-profiling-pipeline.html#create-a-tmux-session"><i class="fa fa-check"></i><b>2.2</b> Create a tmux session</a></li>
<li class="chapter" data-level="2.3" data-path="configure-environment-for-full-profiling-pipeline.html"><a href="configure-environment-for-full-profiling-pipeline.html#define-environment-variables"><i class="fa fa-check"></i><b>2.3</b> Define Environment Variables</a></li>
<li class="chapter" data-level="2.4" data-path="configure-environment-for-full-profiling-pipeline.html"><a href="configure-environment-for-full-profiling-pipeline.html#create-directories"><i class="fa fa-check"></i><b>2.4</b> Create Directories</a></li>
<li class="chapter" data-level="2.5" data-path="configure-environment-for-full-profiling-pipeline.html"><a href="configure-environment-for-full-profiling-pipeline.html#download-software"><i class="fa fa-check"></i><b>2.5</b> Download Software</a></li>
</ul></li>
<li class="chapter" data-level="3" data-path="setup-images.html"><a href="setup-images.html"><i class="fa fa-check"></i><b>3</b> Setup Images</a><ul>
<li class="chapter" data-level="3.1" data-path="setup-images.html"><a href="setup-images.html#upload-images"><i class="fa fa-check"></i><b>3.1</b> Upload Images</a></li>
<li class="chapter" data-level="3.2" data-path="setup-images.html"><a href="setup-images.html#prepare-images"><i class="fa fa-check"></i><b>3.2</b> Prepare Images</a></li>
<li class="chapter" data-level="3.3" data-path="setup-images.html"><a href="setup-images.html#create-list-of-plates"><i class="fa fa-check"></i><b>3.3</b> Create List of Plates</a></li>
<li class="chapter" data-level="3.4" data-path="setup-images.html"><a href="setup-images.html#create-loaddata-csvs"><i class="fa fa-check"></i><b>3.4</b> Create LoadData CSVs</a></li>
<li class="chapter" data-level="3.5" data-path="setup-images.html"><a href="setup-images.html#upload-image-location-files-to-s3"><i class="fa fa-check"></i><b>3.5</b> Upload image location files to S3</a></li>
</ul></li>
<li class="chapter" data-level="4" data-path="run-each-cellprofiler-step.html"><a href="run-each-cellprofiler-step.html"><i class="fa fa-check"></i><b>4</b> Run each CellProfiler step</a><ul>
<li class="chapter" data-level="4.1" data-path="run-each-cellprofiler-step.html"><a href="run-each-cellprofiler-step.html#upload-your-pipelines-to-s3"><i class="fa fa-check"></i><b>4.1</b> Upload your pipelines to S3</a></li>
<li class="chapter" data-level="4.2" data-path="run-each-cellprofiler-step.html"><a href="run-each-cellprofiler-step.html#configure-distributed-cellprofilers-run_batch_general-script"><i class="fa fa-check"></i><b>4.2</b> Configure Distributed-CellProfiler's <code>run_batch_general</code> script</a></li>
<li class="chapter" data-level="4.3" data-path="run-each-cellprofiler-step.html"><a href="run-each-cellprofiler-step.html#configure-distributed-cellprofilers-fleet-file"><i class="fa fa-check"></i><b>4.3</b> Configure Distributed-CellProfiler's fleet file</a></li>
<li class="chapter" data-level="4.4" data-path="run-each-cellprofiler-step.html"><a href="run-each-cellprofiler-step.html#change-required-parameters-in-distributed-cellprofilers-config-file"><i class="fa fa-check"></i><b>4.4</b> Change required parameters in Distributed-CellProfiler's config file</a></li>
<li class="chapter" data-level="4.5" data-path="run-each-cellprofiler-step.html"><a href="run-each-cellprofiler-step.html#run-each-cellprofiler-step-1"><i class="fa fa-check"></i><b>4.5</b> Run each CellProfiler step</a><ul>
<li class="chapter" data-level="4.5.1" data-path="run-each-cellprofiler-step.html"><a href="run-each-cellprofiler-step.html#optional-z-projection-1"><i class="fa fa-check"></i><b>4.5.1</b> (Optional) Z projection</a></li>
<li class="chapter" data-level="4.5.2" data-path="run-each-cellprofiler-step.html"><a href="run-each-cellprofiler-step.html#optional-qc-1"><i class="fa fa-check"></i><b>4.5.2</b> (Optional) QC</a></li>
<li class="chapter" data-level="4.5.3" data-path="run-each-cellprofiler-step.html"><a href="run-each-cellprofiler-step.html#illumination-correction-1"><i class="fa fa-check"></i><b>4.5.3</b> Illumination Correction</a></li>
<li class="chapter" data-level="4.5.4" data-path="run-each-cellprofiler-step.html"><a href="run-each-cellprofiler-step.html#optional-assay-dev"><i class="fa fa-check"></i><b>4.5.4</b> (Optional) Assay Dev</a></li>
<li class="chapter" data-level="4.5.5" data-path="run-each-cellprofiler-step.html"><a href="run-each-cellprofiler-step.html#analysis-1"><i class="fa fa-check"></i><b>4.5.5</b> Analysis</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="5" data-path="do-any-post-cellprofiler-steps.html"><a href="do-any-post-cellprofiler-steps.html"><i class="fa fa-check"></i><b>5</b> Do any post-CellProfiler steps</a></li>
<li class="chapter" data-level="6" data-path="create-profiles.html"><a href="create-profiles.html"><i class="fa fa-check"></i><b>6</b> Create Profiles</a><ul>
<li class="chapter" data-level="6.1" data-path="create-profiles.html"><a href="create-profiles.html#confirm-environment-configuration"><i class="fa fa-check"></i><b>6.1</b> Confirm Environment Configuration</a></li>
<li class="chapter" data-level="6.2" data-path="create-profiles.html"><a href="create-profiles.html#add-a-large-ebs-volume-to-your-machine"><i class="fa fa-check"></i><b>6.2</b> Add a large EBS volume to your machine</a></li>
<li class="chapter" data-level="6.3" data-path="create-profiles.html"><a href="create-profiles.html#create-database-backend"><i class="fa fa-check"></i><b>6.3</b> Create Database Backend</a></li>
</ul></li>
<li class="appendix"><span><b>Appendix</b></span></li>
<li class="chapter" data-level="A" data-path="appendix-a.html"><a href="appendix-a.html"><i class="fa fa-check"></i><b>A</b> Appendix A</a><ul>
<li class="chapter" data-level="A.1" data-path="appendix-a.html"><a href="appendix-a.html#project-folder-structure-guidance"><i class="fa fa-check"></i><b>A.1</b> Project folder structure guidance</a></li>
<li class="chapter" data-level="A.2" data-path="appendix-a.html"><a href="appendix-a.html#directory-structure"><i class="fa fa-check"></i><b>A.2</b> Directory structure</a></li>
</ul></li>
<li class="divider"></li>
<li><a href="https://github.com/rstudio/bookdown" target="blank">Published with bookdown</a></li>

</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">Image-based Profiling Handbook</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="configure-environment-for-full-profiling-pipeline" class="section level1">
<h1><span class="header-section-number">Chapter 2</span> Configure Environment for Full Profiling Pipeline</h1>
<p>This workflow assumes you have already set up an AWS account with an S3 bucket and EFS, and created a VM per the instructions in the link below.</p>
<div id="launch-an-aws-virtual-machine-for-making-csvs-and-running-distributed-cellprofiler" class="section level2">
<h2><span class="header-section-number">2.1</span> Launch an AWS Virtual Machine for making CSVs and running Distributed-CellProfiler</h2>
<p>Launch an EC2 node using AMI <code>cytomining/images/hvm-ssd/cytominer-bionic-trusty-18.04-amd64-server-*</code>, created using <a href="https://github.com/cytomining/cytominer-vm">cytominer-vm</a>.</p>
<p>You will need to create an AMI for your own infrastructure because the provisioning includes mounting S3 and EFS, which is account specific. We recommend using an <code>m4.xlarge</code> instance, with an 8Gb EBS volume.</p>
<p>Note: Proper configuration is essential to mount the S3 bucket. The following configuration provides an example, named <code>imaging-platform</code> (modifications will be necessary).</p>
<ul>
<li>Launch an ec2 instance on AWS</li>
<li>AMI: <code>cytomining/images/hvm-ssd/cytominer-ubuntu-trusty-18.04-amd64-server-1529668435</code></li>
<li>Instance Type: m4.xlarge</li>
<li>Network: vpc-35149752</li>
<li>Subnet: Default (imaging platform terraform)</li>
<li>IAM role: <code>s3-imaging-platform-role</code></li>
<li>No Tags</li>
<li>Select Existing Security Group: <code>SSH_HTTP</code></li>
<li>Review and Launch</li>
<li><code>ssh -i &lt;USER&gt;.pem ubuntu@&lt;Public DNS IPv4&gt;</code></li>
</ul>
<p>After starting the instance, ensure that the S3 bucket is mounted on <code>~/bucket</code>. If not, run <code>sudo mount -a</code>.</p>
<p>Log in to the EC2 instance.</p>
<p>Enter your AWS credentials</p>
<div class="sourceCode"><pre class="sourceCode sh"><code class="sourceCode bash"><span class="ex">aws</span> configure</code></pre></div>
<p>The infrastructure is configured with one S3 bucket. Mount this S3 bucket (if it is not automatically mounted)</p>
<div class="sourceCode"><pre class="sourceCode sh"><code class="sourceCode bash"><span class="fu">sudo</span> mount -a</code></pre></div>
<p>Check that the bucket was was mounted. This path should exist:</p>
<div class="sourceCode"><pre class="sourceCode sh"><code class="sourceCode bash"><span class="fu">ls</span> ~/bucket/projects</code></pre></div>
</div>
<div id="create-a-tmux-session" class="section level2">
<h2><span class="header-section-number">2.2</span> Create a tmux session</h2>
<p>You will want to retain environment variables once defined, and for processes to run when you are not connected, so you should create a tmux session to work in</p>
<div class="sourceCode"><pre class="sourceCode sh"><code class="sourceCode bash"><span class="ex">tmux</span> new -s sessionname</code></pre></div>
<p>You can detach from this session at any time by typing <code>Ctl+b</code>, then <code>d</code>.<br />
To reattach to an existing session, type <code>tmux a -t sessionname</code></p>
<p>You can list existing sessions with <code>tmux list-sessions</code> and kill any poorly-behaving session with <code>tmux kill-session -t sessionname</code></p>
</div>
<div id="define-environment-variables" class="section level2">
<h2><span class="header-section-number">2.3</span> Define Environment Variables</h2>
<p>These variables will be used throughout the project to tag instances, logs etc so that you know which machines are working on what, which files to operate on, where your logs are, etc.</p>
<div class="sourceCode"><pre class="sourceCode sh"><code class="sourceCode bash"><span class="va">PROJECT_NAME=</span>2015_10_05_DrugRepurposing_AravindSubramanian_GolubLab_Broad

<span class="va">BATCH_ID=</span>2016_04_01_a549_48hr_batch1

<span class="va">BUCKET=</span>imaging-platform

<span class="va">MAXPROCS=</span>3 <span class="co"># m4.xlarge has 4 cores; this should be # of cores on your instance - 1</span></code></pre></div>
</div>
<div id="create-directories" class="section level2">
<h2><span class="header-section-number">2.4</span> Create Directories</h2>
<div class="sourceCode"><pre class="sourceCode sh"><code class="sourceCode bash"><span class="fu">mkdir</span> -p ~/efs/<span class="va">${PROJECT_NAME}</span>/workspace/

<span class="bu">cd</span> ~/efs/<span class="va">${PROJECT_NAME}</span>/workspace/

<span class="fu">mkdir</span> -p log/<span class="va">${BATCH_ID}</span></code></pre></div>
</div>
<div id="download-software" class="section level2">
<h2><span class="header-section-number">2.5</span> Download Software</h2>
<div class="sourceCode"><pre class="sourceCode sh"><code class="sourceCode bash"><span class="bu">cd</span> ~/efs/<span class="va">${PROJECT_NAME}</span>/workspace/
<span class="fu">mkdir</span> software
<span class="bu">cd</span> software
<span class="fu">git</span> clone https://github.com/broadinstitute/pe2loaddata.git
<span class="fu">git</span> clone https://github.com/CellProfiler/Distributed-CellProfiler.git

<span class="bu">cd</span> ..</code></pre></div>
<p>If these repos have already been cloned, <code>git pull</code> to make sure they are up to date.</p>
<p>This is the resulting structure of <code>software</code> on EFS (one level below <code>workspace</code>):</p>
<pre><code>└── software
    ├── Distributed-CellProfiler
    └── pe2loaddata</code></pre>

</div>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="introduction.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="setup-images.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/lunr.js"></script>
<script src="libs/gitbook-2.6.7/js/clipboard.min.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-clipboard.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": false,
"facebook": true,
"twitter": true,
"linkedin": false,
"weibo": false,
"instapaper": false,
"vk": false,
"whatsapp": false,
"all": ["facebook", "twitter", "linkedin", "weibo", "instapaper"]
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": "https://github.com/cytomining/profiling-handbook/edit/master/02-config.Rmd",
"text": "Edit"
},
"history": {
"link": null,
"text": null
},
"view": {
"link": null,
"text": null
},
"download": ["bookdown-demo.pdf", "bookdown-demo.epub"],
"search": {
"engine": "lunr",
"options": null
},
"toc": {
"collapse": "subsection"
}
});
});
</script>

</body>

</html>
