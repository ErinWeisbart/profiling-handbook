<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>Chapter 1 Configure environment | Image-based Profiling Handbook</title>
  <meta name="description" content="This is a handbook for processing image-based profiling datasets using CellProfiler and cytominer" />
  <meta name="generator" content="bookdown 0.12.1 and GitBook 2.6.7" />

  <meta property="og:title" content="Chapter 1 Configure environment | Image-based Profiling Handbook" />
  <meta property="og:type" content="book" />
  
  
  <meta property="og:description" content="This is a handbook for processing image-based profiling datasets using CellProfiler and cytominer" />
  <meta name="github-repo" content="rstudio/bookdown-demo" />

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="Chapter 1 Configure environment | Image-based Profiling Handbook" />
  
  <meta name="twitter:description" content="This is a handbook for processing image-based profiling datasets using CellProfiler and cytominer" />
  

<meta name="author" content="Tim Becker, Beth Cimini, Shantanu Singh, Gregory Way" />


<meta name="date" content="2019-07-15" />

  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  
<link rel="prev" href="index.html">
<link rel="next" href="configure-tools-to-process-images.html">
<script src="libs/jquery-2.2.3/jquery.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />









<style type="text/css">
div.sourceCode { overflow-x: auto; }
table.sourceCode, tr.sourceCode, td.lineNumbers, td.sourceCode {
  margin: 0; padding: 0; vertical-align: baseline; border: none; }
table.sourceCode { width: 100%; line-height: 100%; }
td.lineNumbers { text-align: right; padding-right: 4px; padding-left: 4px; color: #aaaaaa; border-right: 1px solid #aaaaaa; }
td.sourceCode { padding-left: 5px; }
code > span.kw { color: #007020; font-weight: bold; } /* Keyword */
code > span.dt { color: #902000; } /* DataType */
code > span.dv { color: #40a070; } /* DecVal */
code > span.bn { color: #40a070; } /* BaseN */
code > span.fl { color: #40a070; } /* Float */
code > span.ch { color: #4070a0; } /* Char */
code > span.st { color: #4070a0; } /* String */
code > span.co { color: #60a0b0; font-style: italic; } /* Comment */
code > span.ot { color: #007020; } /* Other */
code > span.al { color: #ff0000; font-weight: bold; } /* Alert */
code > span.fu { color: #06287e; } /* Function */
code > span.er { color: #ff0000; font-weight: bold; } /* Error */
code > span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
code > span.cn { color: #880000; } /* Constant */
code > span.sc { color: #4070a0; } /* SpecialChar */
code > span.vs { color: #4070a0; } /* VerbatimString */
code > span.ss { color: #bb6688; } /* SpecialString */
code > span.im { } /* Import */
code > span.va { color: #19177c; } /* Variable */
code > span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code > span.op { color: #666666; } /* Operator */
code > span.bu { } /* BuiltIn */
code > span.ex { } /* Extension */
code > span.pp { color: #bc7a00; } /* Preprocessor */
code > span.at { color: #7d9029; } /* Attribute */
code > span.do { color: #ba2121; font-style: italic; } /* Documentation */
code > span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code > span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code > span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
</style>

<link rel="stylesheet" href="style.css" type="text/css" />
</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li><a href="./">Image-based Profiling Handbook</a></li>

<li class="divider"></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i>Preface</a></li>
<li class="part"><span><b>I Configuration</b></span></li>
<li class="chapter" data-level="1" data-path="configure-environment.html"><a href="configure-environment.html"><i class="fa fa-check"></i><b>1</b> Configure environment</a><ul>
<li class="chapter" data-level="1.1" data-path="configure-environment.html"><a href="configure-environment.html#set-up-a-virtual-machine"><i class="fa fa-check"></i><b>1.1</b> Set up a virtual machine</a></li>
<li class="chapter" data-level="1.2" data-path="configure-environment.html"><a href="configure-environment.html#define-variables"><i class="fa fa-check"></i><b>1.2</b> Define variables</a></li>
<li class="chapter" data-level="1.3" data-path="configure-environment.html"><a href="configure-environment.html#create-directories"><i class="fa fa-check"></i><b>1.3</b> Create directories</a></li>
</ul></li>
<li class="part"><span><b>II Images to measurements</b></span></li>
<li class="chapter" data-level="2" data-path="configure-tools-to-process-images.html"><a href="configure-tools-to-process-images.html"><i class="fa fa-check"></i><b>2</b> Configure tools to process images</a><ul>
<li class="chapter" data-level="2.1" data-path="configure-tools-to-process-images.html"><a href="configure-tools-to-process-images.html#download-software"><i class="fa fa-check"></i><b>2.1</b> Download software</a></li>
<li class="chapter" data-level="2.2" data-path="configure-tools-to-process-images.html"><a href="configure-tools-to-process-images.html#setup-distributed-cellprofiler"><i class="fa fa-check"></i><b>2.2</b> Setup Distributed CellProfiler</a></li>
</ul></li>
<li class="chapter" data-level="3" data-path="setup-pipelines-and-images.html"><a href="setup-pipelines-and-images.html"><i class="fa fa-check"></i><b>3</b> Setup pipelines and images</a><ul>
<li class="chapter" data-level="3.1" data-path="setup-pipelines-and-images.html"><a href="setup-pipelines-and-images.html#get-cellprofiler-pipelines"><i class="fa fa-check"></i><b>3.1</b> Get CellProfiler pipelines</a></li>
<li class="chapter" data-level="3.2" data-path="setup-pipelines-and-images.html"><a href="setup-pipelines-and-images.html#specify-pipeline-set"><i class="fa fa-check"></i><b>3.2</b> Specify pipeline set</a></li>
<li class="chapter" data-level="3.3" data-path="setup-pipelines-and-images.html"><a href="setup-pipelines-and-images.html#prepare-images"><i class="fa fa-check"></i><b>3.3</b> Prepare images</a></li>
<li class="chapter" data-level="3.4" data-path="setup-pipelines-and-images.html"><a href="setup-pipelines-and-images.html#create-list-of-plates"><i class="fa fa-check"></i><b>3.4</b> Create list of plates</a></li>
<li class="chapter" data-level="3.5" data-path="setup-pipelines-and-images.html"><a href="setup-pipelines-and-images.html#create-loaddata-csvs"><i class="fa fa-check"></i><b>3.5</b> Create LoadData CSVs</a></li>
</ul></li>
<li class="chapter" data-level="4" data-path="setup-jobs.html"><a href="setup-jobs.html"><i class="fa fa-check"></i><b>4</b> Setup jobs</a><ul>
<li class="chapter" data-level="4.1" data-path="setup-jobs.html"><a href="setup-jobs.html#illumination-correction"><i class="fa fa-check"></i><b>4.1</b> Illumination correction</a></li>
<li class="chapter" data-level="4.2" data-path="setup-jobs.html"><a href="setup-jobs.html#quality-control"><i class="fa fa-check"></i><b>4.2</b> Quality control</a></li>
<li class="chapter" data-level="4.3" data-path="setup-jobs.html"><a href="setup-jobs.html#analysis"><i class="fa fa-check"></i><b>4.3</b> Analysis</a></li>
</ul></li>
<li class="chapter" data-level="5" data-path="run-jobs.html"><a href="run-jobs.html"><i class="fa fa-check"></i><b>5</b> Run jobs</a><ul>
<li class="chapter" data-level="5.1" data-path="run-jobs.html"><a href="run-jobs.html#illumination-correction-1"><i class="fa fa-check"></i><b>5.1</b> Illumination correction</a><ul>
<li class="chapter" data-level="5.1.1" data-path="run-jobs.html"><a href="run-jobs.html#single-node"><i class="fa fa-check"></i><b>5.1.1</b> Single node</a></li>
<li class="chapter" data-level="5.1.2" data-path="run-jobs.html"><a href="run-jobs.html#run-illum-dcp"><i class="fa fa-check"></i><b>5.1.2</b> DCP</a></li>
</ul></li>
<li class="chapter" data-level="5.2" data-path="run-jobs.html"><a href="run-jobs.html#quality-control-1"><i class="fa fa-check"></i><b>5.2</b> Quality control</a><ul>
<li class="chapter" data-level="5.2.1" data-path="run-jobs.html"><a href="run-jobs.html#process-qc-results-into-a-database-for-cpa"><i class="fa fa-check"></i><b>5.2.1</b> Process QC results into a database for CPA</a></li>
</ul></li>
<li class="chapter" data-level="5.3" data-path="run-jobs.html"><a href="run-jobs.html#analysis-1"><i class="fa fa-check"></i><b>5.3</b> Analysis</a><ul>
<li class="chapter" data-level="5.3.1" data-path="run-jobs.html"><a href="run-jobs.html#single-node-1"><i class="fa fa-check"></i><b>5.3.1</b> Single node</a></li>
<li class="chapter" data-level="5.3.2" data-path="run-jobs.html"><a href="run-jobs.html#dcp"><i class="fa fa-check"></i><b>5.3.2</b> DCP</a></li>
</ul></li>
</ul></li>
<li class="part"><span><b>III Measurements to profiles</b></span></li>
<li class="chapter" data-level="6" data-path="configure-tools-to-create-profiles.html"><a href="configure-tools-to-create-profiles.html"><i class="fa fa-check"></i><b>6</b> Configure tools to create profiles</a><ul>
<li class="chapter" data-level="6.1" data-path="configure-tools-to-create-profiles.html"><a href="configure-tools-to-create-profiles.html#download-software-1"><i class="fa fa-check"></i><b>6.1</b> Download software</a></li>
</ul></li>
<li class="chapter" data-level="7" data-path="create-profiles.html"><a href="create-profiles.html"><i class="fa fa-check"></i><b>7</b> Create profiles</a><ul>
<li class="chapter" data-level="7.1" data-path="create-profiles.html"><a href="create-profiles.html#create-database-backend"><i class="fa fa-check"></i><b>7.1</b> Create database backend</a></li>
<li class="chapter" data-level="7.2" data-path="create-profiles.html"><a href="create-profiles.html#annotate"><i class="fa fa-check"></i><b>7.2</b> Annotate</a></li>
<li class="chapter" data-level="7.3" data-path="create-profiles.html"><a href="create-profiles.html#normalize"><i class="fa fa-check"></i><b>7.3</b> Normalize</a></li>
<li class="chapter" data-level="7.4" data-path="create-profiles.html"><a href="create-profiles.html#select-variables"><i class="fa fa-check"></i><b>7.4</b> Select variables</a></li>
<li class="chapter" data-level="7.5" data-path="create-profiles.html"><a href="create-profiles.html#aggregate-replicates"><i class="fa fa-check"></i><b>7.5</b> Aggregate replicates</a></li>
<li class="chapter" data-level="7.6" data-path="create-profiles.html"><a href="create-profiles.html#audit"><i class="fa fa-check"></i><b>7.6</b> Audit</a></li>
<li class="chapter" data-level="7.7" data-path="create-profiles.html"><a href="create-profiles.html#convert-to-other-formats"><i class="fa fa-check"></i><b>7.7</b> Convert to other formats</a></li>
<li class="chapter" data-level="7.8" data-path="create-profiles.html"><a href="create-profiles.html#upload-data"><i class="fa fa-check"></i><b>7.8</b> Upload data</a><ul>
<li class="chapter" data-level="7.8.1" data-path="create-profiles.html"><a href="create-profiles.html#sync-to-s3"><i class="fa fa-check"></i><b>7.8.1</b> Sync to S3</a></li>
<li class="chapter" data-level="7.8.2" data-path="create-profiles.html"><a href="create-profiles.html#sync-down-from-s3-onto-a-machine"><i class="fa fa-check"></i><b>7.8.2</b> Sync down from S3 onto a machine</a></li>
</ul></li>
</ul></li>
<li class="appendix"><span><b>Appendix</b></span></li>
<li class="chapter" data-level="A" data-path="appendix-a.html"><a href="appendix-a.html"><i class="fa fa-check"></i><b>A</b> Appendix A</a><ul>
<li class="chapter" data-level="A.1" data-path="appendix-a.html"><a href="appendix-a.html#project-folder-structure-guidance"><i class="fa fa-check"></i><b>A.1</b> Project folder structure guidance</a></li>
<li class="chapter" data-level="A.2" data-path="appendix-a.html"><a href="appendix-a.html#directory-structure"><i class="fa fa-check"></i><b>A.2</b> Directory structure</a></li>
</ul></li>
<li class="divider"></li>
<li><a href="https://github.com/rstudio/bookdown" target="blank">Published with bookdown</a></li>

</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">Image-based Profiling Handbook</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="configure-environment" class="section level1">
<h1><span class="header-section-number">Chapter 1</span> Configure environment</h1>
<div id="set-up-a-virtual-machine" class="section level2">
<h2><span class="header-section-number">1.1</span> Set up a virtual machine</h2>
<p>This example assumes that AWS infrastructure has been set up using <a href="https://github.com/broadinstitute/aws-infrastructure-cellpainting" class="uri">https://github.com/broadinstitute/aws-infrastructure-cellpainting</a></p>
<p>Launch an EC2 node using AMI <code>cytomining/images/hvm-ssd/cytominer-ubuntu-trusty-14.04-amd64-server-*</code>, created using <a href="https://github.com/broadinstitute/imaging-vms/blob/master/cytominer/cytominer_ami.json" class="uri">https://github.com/broadinstitute/imaging-vms/blob/master/cytominer/cytominer_ami.json</a>. Note that the region must be set to <code>US East (N. Virginia)</code>. To use a different region, modify the <code>vpc</code> module in the AWS infrastructure setup.</p>
<p>You will need to create an AMI for your own infrastructure because the provisioning includes mounting S4 and EFS, which is account specific. See <code>module &quot;ec2_login&quot;</code> in the Terraform <a href="https://github.com/broadinstitute/aws-infrastructure-cellpainting/blob/master/terraform/main.tf">configuration</a> for how to configure the security groups and IAM roles for this instance. The simplest approach is to launch another node identical to <code>ec2_login</code>, which is set up in this infrastructure. We recommend using an <code>m4.xlarge</code> instance, with a 110Gb EBS volume.</p>

<div class="rmdnote">
Note: Proper configuration is essential to mount the <code>imaging_platform</code> S3 bucket. The following configuration provides an example to set this up properly. Some modifications may be necessary. * Launch an ec2 instance on AWS * AMI: cytomining/images/hvm-ssd/cytominer-ubuntu-trusty-14.04-amd64-server-1529668435 * Instance Type: m4.xlarge * Network: vpc-35149752 - Subnet: Default (imaging platform terraform) * IAM role: <code>s3-imaging-platform-role   * Add New Volume (if necessary):</code>EBS<code>with 110 GiB   * No Tags   * Select Existing Security Group:</code>SSH_HTTP<code>* Review and Launch   * ssh -i &lt;USER&gt;.pem ubuntu@&lt;Public DNS IPv4&gt;   * Inside AWS terminal:</code>aws configure` and input security credentials
</div>

<p>After starting the instance, ensure that the S3 bucket is mounted on <code>~/bucket</code>. If not, do <code>sudo mount -a</code></p>

<div class="rmdnote">
Note that given this configuration in this AMI, EFS can only be mounted from <code>us-east-1a</code> or <code>us-east-1b</code>. This can be changed by appropriately editing the EFS configuration via Terraform.
</div>

<p>Log in to the EC2 instance.</p>
<p>Check available space on the instance</p>
<div class="sourceCode"><pre class="sourceCode sh"><code class="sourceCode bash"><span class="fu">df</span> -h</code></pre></div>
<p>Ensure that the <code>Available</code> column is at least 30Gb x <code>p</code>, where <code>p</code> is the number of plates you will process in parallel when creating the database backend. We recommend <code>p</code> to be one less than the number of cores (<code>p</code> = 3 for <code>m4.xlarge</code>, so 60Gb should be available). If you don’t have sufficient space, mount an EBS volume (below).</p>
<p>Enter your AWS credentials</p>
<div class="sourceCode"><pre class="sourceCode sh"><code class="sourceCode bash"><span class="ex">aws</span> configure</code></pre></div>
<p>The infrastructure is configure with one S3 bucket. Mount this S3 bucket (if it is not automatically mounted)</p>
<div class="sourceCode"><pre class="sourceCode sh"><code class="sourceCode bash"><span class="fu">sudo</span> mount -a</code></pre></div>
<p>Check that the bucket was was mounted. This path should exist:</p>
<div class="sourceCode"><pre class="sourceCode sh"><code class="sourceCode bash"><span class="fu">ls</span> ~/bucket/projects</code></pre></div>
</div>
<div id="define-variables" class="section level2">
<h2><span class="header-section-number">1.2</span> Define variables</h2>
<div class="sourceCode"><pre class="sourceCode sh"><code class="sourceCode bash"><span class="va">PROJECT_NAME=</span>2015_10_05_DrugRepurposing_AravindSubramanian_GolubLab_Broad

<span class="va">BATCH_ID=</span>2016_04_01_a549_48hr_batch1

<span class="va">BUCKET=</span>imaging-platform

<span class="va">MAXPROCS=</span>3 <span class="co"># m4.xlarge has 4 cores; keep 1 free</span></code></pre></div>
</div>
<div id="create-directories" class="section level2">
<h2><span class="header-section-number">1.3</span> Create directories</h2>

<div class="rmdcaution">
See note above about EFS - that it can only be mounted from us-east-1a or 1b.
</div>

<div class="sourceCode"><pre class="sourceCode sh"><code class="sourceCode bash"><span class="fu">mkdir</span> -p ~/efs/<span class="va">${PROJECT_NAME}</span>/workspace/

<span class="bu">cd</span> ~/efs/<span class="va">${PROJECT_NAME}</span>/workspace/

<span class="fu">mkdir</span> -p log/<span class="va">${BATCH_ID}</span></code></pre></div>
<p>Create a temp directory which is required when creating the database backed using <code>cytominer-database</code> (discussed later). This is also useful if you decide to run CellProfiler directly on this node – running the Cell Painting analysis spipeline results in large temporary files.</p>
<div class="sourceCode"><pre class="sourceCode sh"><code class="sourceCode bash"><span class="fu">mkdir</span> ~/ebs_tmp</code></pre></div>

<div class="rmdnote">
If at this point you realize that the ec2 instance does not have enough space (which you can check using <code>du -h</code>), create and attach an EBS volume, and then mount it. Make sure that the EBS is created in the same region and availability zone as the ec2 instance. For more information about mounting the EBS see <a href="https://devopscube.com/mount-ebs-volume-ec2-instance/" class="uri">https://devopscube.com/mount-ebs-volume-ec2-instance/</a>.
</div>

<div class="sourceCode"><pre class="sourceCode sh"><code class="sourceCode bash"><span class="co"># check the name of the disk</span>
<span class="ex">lsblk</span>

<span class="co">#&gt; NAME    MAJ:MIN RM   SIZE RO TYPE MOUNTPOINT</span>
<span class="co">#&gt; xvda    202:0    0     8G  0 disk</span>
<span class="co">#&gt; └─xvda1 202:1    0     8G  0 part /</span>
<span class="co">#&gt; xvdf    202:80   0   100G  0 disk</span>

<span class="co"># check if it has a file system</span>
<span class="fu">sudo</span> file -s /dev/xvdf
<span class="co"># ...likely not, in which case you get:</span>
<span class="co">#&gt; /dev/xvdf: data</span>

<span class="co"># if no file system, then create it</span>
<span class="fu">sudo</span> mkfs -t ext4 /dev/xvdf

<span class="co"># mount it</span>
<span class="fu">sudo</span> mount /dev/xvdf /home/ubuntu/ebs_tmp/

<span class="co"># change perm</span>
<span class="fu">sudo</span> chmod 777 ~/ebs_tmp/</code></pre></div>

</div>
</div>



            </section>

          </div>
        </div>
      </div>
<a href="index.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="configure-tools-to-process-images.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/lunr.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": false,
"facebook": true,
"twitter": true,
"google": false,
"linkedin": false,
"weibo": false,
"instapaper": false,
"vk": false,
"all": ["facebook", "google", "twitter", "linkedin", "weibo", "instapaper"]
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": "https://github.com/cytomining/profiling-handbook/edit/master/01-config.Rmd",
"text": "Edit"
},
"history": {
"link": null,
"text": null
},
"download": ["bookdown-demo.pdf", "bookdown-demo.epub"],
"toc": {
"collapse": "subsection"
}
});
});
</script>

</body>

</html>
