<!DOCTYPE html>
<html lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>Chapter 6 Create Profiles | Image-based Profiling Handbook</title>
  <meta name="description" content="This is a handbook for processing image-based profiling datasets using CellProfiler and cytominer" />
  <meta name="generator" content="bookdown 0.20.1 and GitBook 2.6.7" />

  <meta property="og:title" content="Chapter 6 Create Profiles | Image-based Profiling Handbook" />
  <meta property="og:type" content="book" />
  
  
  <meta property="og:description" content="This is a handbook for processing image-based profiling datasets using CellProfiler and cytominer" />
  <meta name="github-repo" content="rstudio/bookdown-demo" />

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="Chapter 6 Create Profiles | Image-based Profiling Handbook" />
  
  <meta name="twitter:description" content="This is a handbook for processing image-based profiling datasets using CellProfiler and cytominer" />
  

<meta name="author" content="Tim Becker, Beth Cimini, Shantanu Singh, Gregory Way, Hamdah Abbasi" />


<meta name="date" content="2020-07-09" />

  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  
<link rel="prev" href="run-jobs.html"/>
<link rel="next" href="appendix-a.html"/>
<script src="libs/jquery-2.2.3/jquery.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-clipboard.css" rel="stylesheet" />











<style type="text/css">
div.sourceCode { overflow-x: auto; }
table.sourceCode, tr.sourceCode, td.lineNumbers, td.sourceCode {
  margin: 0; padding: 0; vertical-align: baseline; border: none; }
table.sourceCode { width: 100%; line-height: 100%; }
td.lineNumbers { text-align: right; padding-right: 4px; padding-left: 4px; color: #aaaaaa; border-right: 1px solid #aaaaaa; }
td.sourceCode { padding-left: 5px; }
code > span.kw { color: #007020; font-weight: bold; } /* Keyword */
code > span.dt { color: #902000; } /* DataType */
code > span.dv { color: #40a070; } /* DecVal */
code > span.bn { color: #40a070; } /* BaseN */
code > span.fl { color: #40a070; } /* Float */
code > span.ch { color: #4070a0; } /* Char */
code > span.st { color: #4070a0; } /* String */
code > span.co { color: #60a0b0; font-style: italic; } /* Comment */
code > span.ot { color: #007020; } /* Other */
code > span.al { color: #ff0000; font-weight: bold; } /* Alert */
code > span.fu { color: #06287e; } /* Function */
code > span.er { color: #ff0000; font-weight: bold; } /* Error */
code > span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
code > span.cn { color: #880000; } /* Constant */
code > span.sc { color: #4070a0; } /* SpecialChar */
code > span.vs { color: #4070a0; } /* VerbatimString */
code > span.ss { color: #bb6688; } /* SpecialString */
code > span.im { } /* Import */
code > span.va { color: #19177c; } /* Variable */
code > span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code > span.op { color: #666666; } /* Operator */
code > span.bu { } /* BuiltIn */
code > span.ex { } /* Extension */
code > span.pp { color: #bc7a00; } /* Preprocessor */
code > span.at { color: #7d9029; } /* Attribute */
code > span.do { color: #ba2121; font-style: italic; } /* Documentation */
code > span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code > span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code > span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
</style>

<link rel="stylesheet" href="style.css" type="text/css" />
</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li><a href="./">Image-based Profiling Handbook</a></li>

<li class="divider"></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i>Preface</a></li>
<li class="part"><span><b>I Configuration</b></span></li>
<li class="chapter" data-level="1" data-path="configure-environment-for-full-profiling-pipeline.html"><a href="configure-environment-for-full-profiling-pipeline.html"><i class="fa fa-check"></i><b>1</b> Configure Environment for Full Profiling Pipeline</a><ul>
<li class="chapter" data-level="1.1" data-path="configure-environment-for-full-profiling-pipeline.html"><a href="configure-environment-for-full-profiling-pipeline.html#launch-an-aws-virtual-machine"><i class="fa fa-check"></i><b>1.1</b> Launch an AWS Virtual Machine</a></li>
<li class="chapter" data-level="1.2" data-path="configure-environment-for-full-profiling-pipeline.html"><a href="configure-environment-for-full-profiling-pipeline.html#define-environment-variables"><i class="fa fa-check"></i><b>1.2</b> Define Environment Variables</a></li>
<li class="chapter" data-level="1.3" data-path="configure-environment-for-full-profiling-pipeline.html"><a href="configure-environment-for-full-profiling-pipeline.html#create-directories"><i class="fa fa-check"></i><b>1.3</b> Create Directories</a></li>
</ul></li>
<li class="part"><span><b>II Images to measurements</b></span></li>
<li class="chapter" data-level="2" data-path="configure-tools-to-process-images.html"><a href="configure-tools-to-process-images.html"><i class="fa fa-check"></i><b>2</b> Configure Tools to Process Images</a><ul>
<li class="chapter" data-level="2.1" data-path="configure-tools-to-process-images.html"><a href="configure-tools-to-process-images.html#download-software"><i class="fa fa-check"></i><b>2.1</b> Download Software</a></li>
<li class="chapter" data-level="2.2" data-path="configure-tools-to-process-images.html"><a href="configure-tools-to-process-images.html#update-some-packages"><i class="fa fa-check"></i><b>2.2</b> Update some packages</a><ul>
<li class="chapter" data-level="2.2.1" data-path="configure-tools-to-process-images.html"><a href="configure-tools-to-process-images.html#cytominer-database"><i class="fa fa-check"></i><b>2.2.1</b> cytominer-database</a></li>
</ul></li>
<li class="chapter" data-level="2.3" data-path="configure-tools-to-process-images.html"><a href="configure-tools-to-process-images.html#setup-distributed-cellprofiler"><i class="fa fa-check"></i><b>2.3</b> Setup Distributed CellProfiler</a></li>
</ul></li>
<li class="chapter" data-level="3" data-path="setup-pipelines-and-images.html"><a href="setup-pipelines-and-images.html"><i class="fa fa-check"></i><b>3</b> Setup Pipelines and Images</a><ul>
<li class="chapter" data-level="3.1" data-path="setup-pipelines-and-images.html"><a href="setup-pipelines-and-images.html#get-cellprofiler-pipelines"><i class="fa fa-check"></i><b>3.1</b> Get CellProfiler Pipelines</a></li>
<li class="chapter" data-level="3.2" data-path="setup-pipelines-and-images.html"><a href="setup-pipelines-and-images.html#specify-pipeline-set"><i class="fa fa-check"></i><b>3.2</b> Specify Pipeline Set</a></li>
<li class="chapter" data-level="3.3" data-path="setup-pipelines-and-images.html"><a href="setup-pipelines-and-images.html#upload-images"><i class="fa fa-check"></i><b>3.3</b> Upload Images</a></li>
<li class="chapter" data-level="3.4" data-path="setup-pipelines-and-images.html"><a href="setup-pipelines-and-images.html#prepare-images"><i class="fa fa-check"></i><b>3.4</b> Prepare Images</a></li>
<li class="chapter" data-level="3.5" data-path="setup-pipelines-and-images.html"><a href="setup-pipelines-and-images.html#create-list-of-plates"><i class="fa fa-check"></i><b>3.5</b> Create List of Plates</a></li>
<li class="chapter" data-level="3.6" data-path="setup-pipelines-and-images.html"><a href="setup-pipelines-and-images.html#create-loaddata-csvs"><i class="fa fa-check"></i><b>3.6</b> Create LoadData CSVs</a></li>
</ul></li>
<li class="chapter" data-level="4" data-path="setup-jobs.html"><a href="setup-jobs.html"><i class="fa fa-check"></i><b>4</b> Setup Jobs</a><ul>
<li class="chapter" data-level="4.1" data-path="setup-jobs.html"><a href="setup-jobs.html#illumination-correction"><i class="fa fa-check"></i><b>4.1</b> Illumination Correction</a></li>
<li class="chapter" data-level="4.2" data-path="setup-jobs.html"><a href="setup-jobs.html#quality-control"><i class="fa fa-check"></i><b>4.2</b> Quality Control</a></li>
<li class="chapter" data-level="4.3" data-path="setup-jobs.html"><a href="setup-jobs.html#analysis"><i class="fa fa-check"></i><b>4.3</b> Analysis</a></li>
</ul></li>
<li class="chapter" data-level="5" data-path="run-jobs.html"><a href="run-jobs.html"><i class="fa fa-check"></i><b>5</b> Run Jobs</a><ul>
<li class="chapter" data-level="5.1" data-path="setup-jobs.html"><a href="setup-jobs.html#illumination-correction"><i class="fa fa-check"></i><b>5.1</b> Illumination Correction</a><ul>
<li class="chapter" data-level="5.1.1" data-path="run-jobs.html"><a href="run-jobs.html#single-node"><i class="fa fa-check"></i><b>5.1.1</b> Single Node</a></li>
<li class="chapter" data-level="5.1.2" data-path="run-jobs.html"><a href="run-jobs.html#run-illum-dcp"><i class="fa fa-check"></i><b>5.1.2</b> DCP</a></li>
</ul></li>
<li class="chapter" data-level="5.2" data-path="setup-jobs.html"><a href="setup-jobs.html#quality-control"><i class="fa fa-check"></i><b>5.2</b> Quality Control</a><ul>
<li class="chapter" data-level="5.2.1" data-path="run-jobs.html"><a href="run-jobs.html#process-qc-results-into-a-database-for-cpa"><i class="fa fa-check"></i><b>5.2.1</b> Process QC Results into a Database for CPA</a></li>
</ul></li>
<li class="chapter" data-level="5.3" data-path="setup-jobs.html"><a href="setup-jobs.html#analysis"><i class="fa fa-check"></i><b>5.3</b> Analysis</a><ul>
<li class="chapter" data-level="5.3.1" data-path="run-jobs.html"><a href="run-jobs.html#single-node-1"><i class="fa fa-check"></i><b>5.3.1</b> Single Node</a></li>
<li class="chapter" data-level="5.3.2" data-path="run-jobs.html"><a href="run-jobs.html#dcp"><i class="fa fa-check"></i><b>5.3.2</b> DCP</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="6" data-path="create-profiles.html"><a href="create-profiles.html"><i class="fa fa-check"></i><b>6</b> Create Profiles</a><ul>
<li class="chapter" data-level="6.1" data-path="create-profiles.html"><a href="create-profiles.html#confirm-environment-configuration"><i class="fa fa-check"></i><b>6.1</b> Confirm Environment Configuration</a></li>
<li class="chapter" data-level="6.2" data-path="create-profiles.html"><a href="create-profiles.html#create-database-backend"><i class="fa fa-check"></i><b>6.2</b> Create Database Backend</a><ul>
<li class="chapter" data-level="6.2.1" data-path="create-profiles.html"><a href="create-profiles.html#copy-files-from-s3-to-efs"><i class="fa fa-check"></i><b>6.2.1</b> Copy Files from S3 to EFS</a></li>
<li class="chapter" data-level="6.2.2" data-path="create-profiles.html"><a href="create-profiles.html#quick-check-rows"><i class="fa fa-check"></i><b>6.2.2</b> Quick Check Rows</a></li>
<li class="chapter" data-level="6.2.3" data-path="create-profiles.html"><a href="create-profiles.html#something-amiss"><i class="fa fa-check"></i><b>6.2.3</b> Something Amiss?</a></li>
</ul></li>
<li class="chapter" data-level="6.3" data-path="create-profiles.html"><a href="create-profiles.html#annotate"><i class="fa fa-check"></i><b>6.3</b> Annotate</a><ul>
<li class="chapter" data-level="6.3.1" data-path="create-profiles.html"><a href="create-profiles.html#example-1-simple-metadata"><i class="fa fa-check"></i><b>6.3.1</b> Example 1: Simple Metadata</a></li>
<li class="chapter" data-level="6.3.2" data-path="create-profiles.html"><a href="create-profiles.html#example-2-complex-metadata"><i class="fa fa-check"></i><b>6.3.2</b> Example 2: Complex Metadata</a></li>
<li class="chapter" data-level="6.3.3" data-path="create-profiles.html"><a href="create-profiles.html#expected-folder-structure"><i class="fa fa-check"></i><b>6.3.3</b> Expected Folder Structure</a></li>
<li class="chapter" data-level="6.3.4" data-path="create-profiles.html"><a href="create-profiles.html#quick-check-rows-1"><i class="fa fa-check"></i><b>6.3.4</b> Quick Check Rows</a></li>
<li class="chapter" data-level="6.3.5" data-path="create-profiles.html"><a href="create-profiles.html#something-amiss-1"><i class="fa fa-check"></i><b>6.3.5</b> Something Amiss?</a></li>
</ul></li>
<li class="chapter" data-level="6.4" data-path="create-profiles.html"><a href="create-profiles.html#normalize"><i class="fa fa-check"></i><b>6.4</b> Normalize</a><ul>
<li class="chapter" data-level="6.4.1" data-path="create-profiles.html"><a href="create-profiles.html#expected-folder-structure-1"><i class="fa fa-check"></i><b>6.4.1</b> Expected Folder Structure</a></li>
<li class="chapter" data-level="6.4.2" data-path="create-profiles.html"><a href="create-profiles.html#quick-check-rows-2"><i class="fa fa-check"></i><b>6.4.2</b> Quick Check Rows</a></li>
<li class="chapter" data-level="6.4.3" data-path="create-profiles.html"><a href="create-profiles.html#something-amiss-2"><i class="fa fa-check"></i><b>6.4.3</b> Something Amiss?</a></li>
</ul></li>
<li class="chapter" data-level="6.5" data-path="create-profiles.html"><a href="create-profiles.html#select-variables"><i class="fa fa-check"></i><b>6.5</b> Select Variables</a><ul>
<li class="chapter" data-level="6.5.1" data-path="create-profiles.html"><a href="create-profiles.html#sample-data"><i class="fa fa-check"></i><b>6.5.1</b> Sample Data</a></li>
<li class="chapter" data-level="6.5.2" data-path="create-profiles.html"><a href="create-profiles.html#preselect"><i class="fa fa-check"></i><b>6.5.2</b> Preselect</a></li>
<li class="chapter" data-level="6.5.3" data-path="create-profiles.html"><a href="create-profiles.html#alternate-load-previous-preselect-configuration"><i class="fa fa-check"></i><b>6.5.3</b> Alternate: Load previous preselect configuration</a></li>
</ul></li>
<li class="chapter" data-level="6.6" data-path="create-profiles.html"><a href="create-profiles.html#execute-feature-selection"><i class="fa fa-check"></i><b>6.6</b> Execute Feature Selection</a><ul>
<li class="chapter" data-level="6.6.1" data-path="create-profiles.html"><a href="create-profiles.html#expected-folder-structure-2"><i class="fa fa-check"></i><b>6.6.1</b> Expected Folder Structure</a></li>
<li class="chapter" data-level="6.6.2" data-path="create-profiles.html"><a href="create-profiles.html#quick-check-rows-3"><i class="fa fa-check"></i><b>6.6.2</b> Quick Check Rows</a></li>
<li class="chapter" data-level="6.6.3" data-path="create-profiles.html"><a href="create-profiles.html#something-amiss-3"><i class="fa fa-check"></i><b>6.6.3</b> Something Amiss?</a></li>
</ul></li>
<li class="chapter" data-level="6.7" data-path="create-profiles.html"><a href="create-profiles.html#aggregate-replicates"><i class="fa fa-check"></i><b>6.7</b> Aggregate Replicates</a><ul>
<li class="chapter" data-level="6.7.1" data-path="create-profiles.html"><a href="create-profiles.html#expected-folder-structure-3"><i class="fa fa-check"></i><b>6.7.1</b> Expected Folder Structure</a></li>
<li class="chapter" data-level="6.7.2" data-path="create-profiles.html"><a href="create-profiles.html#quick-check-rows-4"><i class="fa fa-check"></i><b>6.7.2</b> Quick Check Rows</a></li>
<li class="chapter" data-level="6.7.3" data-path="create-profiles.html"><a href="create-profiles.html#combine-averaged-profiles"><i class="fa fa-check"></i><b>6.7.3</b> Combine Averaged Profiles</a></li>
</ul></li>
<li class="chapter" data-level="6.8" data-path="create-profiles.html"><a href="create-profiles.html#audit"><i class="fa fa-check"></i><b>6.8</b> Audit</a><ul>
<li class="chapter" data-level="6.8.1" data-path="create-profiles.html"><a href="create-profiles.html#treatment-audit"><i class="fa fa-check"></i><b>6.8.1</b> Treatment Audit</a></li>
<li class="chapter" data-level="6.8.2" data-path="create-profiles.html"><a href="create-profiles.html#control-audit"><i class="fa fa-check"></i><b>6.8.2</b> Control Audit</a></li>
</ul></li>
<li class="chapter" data-level="6.9" data-path="create-profiles.html"><a href="create-profiles.html#convert-to-other-formats"><i class="fa fa-check"></i><b>6.9</b> Convert to Other Formats</a><ul>
<li class="chapter" data-level="6.9.1" data-path="create-profiles.html"><a href="create-profiles.html#convert-per-plate-csv-files-to-gct"><i class="fa fa-check"></i><b>6.9.1</b> Convert per-plate CSV files to GCT</a></li>
<li class="chapter" data-level="6.9.2" data-path="create-profiles.html"><a href="create-profiles.html#convert-per-plate-map-csv-files-to-gct"><i class="fa fa-check"></i><b>6.9.2</b> Convert per-plate map CSV files to GCT</a></li>
<li class="chapter" data-level="6.9.3" data-path="create-profiles.html"><a href="create-profiles.html#convert-the-replicate-collapsed-csv-file-to-gct"><i class="fa fa-check"></i><b>6.9.3</b> Convert the replicate-collapsed CSV file to gct</a></li>
</ul></li>
<li class="chapter" data-level="6.10" data-path="create-profiles.html"><a href="create-profiles.html#upload-data"><i class="fa fa-check"></i><b>6.10</b> Upload Data</a><ul>
<li class="chapter" data-level="6.10.1" data-path="create-profiles.html"><a href="create-profiles.html#sync-to-s3"><i class="fa fa-check"></i><b>6.10.1</b> Sync to S3</a></li>
<li class="chapter" data-level="6.10.2" data-path="create-profiles.html"><a href="create-profiles.html#sync-down-from-s3-onto-a-machine"><i class="fa fa-check"></i><b>6.10.2</b> Sync Down from S3 onto a Machine</a></li>
<li class="chapter" data-level="6.10.3" data-path="create-profiles.html"><a href="create-profiles.html#sync-the-files"><i class="fa fa-check"></i><b>6.10.3</b> Sync the files</a></li>
</ul></li>
</ul></li>
<li class="appendix"><span><b>Appendix</b></span></li>
<li class="chapter" data-level="A" data-path="appendix-a.html"><a href="appendix-a.html"><i class="fa fa-check"></i><b>A</b> Appendix A</a><ul>
<li class="chapter" data-level="A.1" data-path="appendix-a.html"><a href="appendix-a.html#project-folder-structure-guidance"><i class="fa fa-check"></i><b>A.1</b> Project folder structure guidance</a></li>
<li class="chapter" data-level="A.2" data-path="appendix-a.html"><a href="appendix-a.html#directory-structure"><i class="fa fa-check"></i><b>A.2</b> Directory structure</a></li>
</ul></li>
<li class="divider"></li>
<li><a href="https://github.com/rstudio/bookdown" target="blank">Published with bookdown</a></li>

</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">Image-based Profiling Handbook</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="create-profiles" class="section level1">
<h1><span class="header-section-number">Chapter 6</span> Create Profiles</h1>
<div id="confirm-environment-configuration" class="section level2">
<h2><span class="header-section-number">6.1</span> Confirm Environment Configuration</h2>
<p>If you are starting from here, make sure the following steps have been completed on your ec2 instance and/or session before proceeding</p>
<ul>
<li>[Configure Environment for Full Profiling Pipeline]</li>
<li>[Download software]</li>
<li>[Create list of plates]</li>
</ul>
</div>
<div id="create-database-backend" class="section level2">
<h2><span class="header-section-number">6.2</span> Create Database Backend</h2>
<p>Run creation of sqlite backend as well as aggregation of measurements into per-well profiles. This process can be very slow since the files are read from s3fs/EFS. We recommend first downloading the CSVs files locally on an EBS volume attached to the ec2 instance you are running on, and then ingesting.</p>
<p>To do so, first recreate the analysis output folder structure on the EBS volume:</p>
<div class="sourceCode"><pre class="sourceCode sh"><code class="sourceCode bash"><span class="fu">mkdir</span> -p ~/ebs_tmp/<span class="va">${PROJECT_NAME}</span>/workspace/software

<span class="bu">cd</span> ~/ebs_tmp/<span class="va">${PROJECT_NAME}</span>/workspace/software

<span class="kw">if</span><span class="bu"> [</span> <span class="ot">-d</span> cytominer_scripts<span class="bu"> ]</span>; <span class="kw">then</span> <span class="fu">rm</span> -rf cytominer_scripts<span class="kw">;</span> <span class="kw">fi</span>

<span class="fu">git</span> clone https://github.com/broadinstitute/cytominer_scripts.git

<span class="bu">cd</span> cytominer_scripts</code></pre></div>
<p>The command below first calls <code>cytominer-database ingest</code> to create the SQLite backend, and then <code>aggregate.R</code> to create per-well profiles. Once complete, all files are uploaded to S3 and the local cache are deleted.</p>
<p><a href="https://github.com/broadinstitute/cytominer_scripts/blob/master/collate.R">collate.R</a> ingests the database and then calls <code>aggregate.R</code>.</p>
<div class="sourceCode"><pre class="sourceCode sh"><code class="sourceCode bash"><span class="ex">pyenv</span> shell 3.5.1

<span class="fu">mkdir</span> -p  ../../log/<span class="va">${BATCH_ID}</span>/
<span class="ex">parallel</span> \
  --max-procs <span class="va">${MAXPROCS}</span> \
  --eta \
  --joblog ../../log/<span class="va">${BATCH_ID}</span>/collate.log \
  --results ../../log/<span class="va">${BATCH_ID}</span>/collate \
  --files \
  --keep-order \
  ./collate.R \
  --batch_id <span class="va">${BATCH_ID}</span> \
  --plate <span class="dt">{1}</span> \
  --config ingest_config.ini \
  --tmpdir ~/ebs_tmp \
  --download \
  --remote_base_dir s3://<span class="va">${BUCKET}</span>/projects/<span class="va">${PROJECT_NAME}</span>/workspace :::: <span class="va">${PLATES}</span></code></pre></div>

<div class="rmdnote">
<code>collate.R</code> does not recreate the SQLite backend if it already exists in the local cache. Add <code>--overwrite_backend_cache</code> flag to recreate.
</div>


<div class="rmdnote">
For pipelines that use FlagImage to skip the measurements modules if the image failed QC, the failed images will have Image.csv files with fewer columns that the rest (because columns corresponding to aggregated measurements will be absent). The ingest command will show a warning related to sqlite: <code>expected X columns but found Y - filling the rest with NULL</code>. This is expected behavior.
</div>


<div class="rmdnote">
There is a known <a href="https://github.com/cytomining/cytominer-database/issues/100">issue</a> where if the alphabetically-first CSV failed QC in a pipeline where &quot;Skip image if flagged&quot; is turned on, the databases will not be created. We are working to fix this, but in the meantime we recommend either not skipping processing of your flagged images (and removing them from your data downstream) or deleting the alphabetically-first CSVs until you come to one where the pipeline ran completely.
</div>

<p>This is the resulting structure of <code>backend</code> on S3 (one level below <code>workspace</code>) for <code>SQ00015167</code>:</p>
<pre><code>└── backend
    └── 2016_04_01_a549_48hr_batch1
        └── SQ00015167
            ├── SQ00015167.csv
            └── SQ00015167.sqlite</code></pre>
<p><code>SQ00015167.sqlite</code> is the per cell data and <code>SQ00015167.csv</code> is the aggregated per-well data.</p>
<div id="copy-files-from-s3-to-efs" class="section level3">
<h3><span class="header-section-number">6.2.1</span> Copy Files from S3 to EFS</h3>
<p>Copy these files from S3 to EFS to continue with the rest of the processing</p>
<div class="sourceCode"><pre class="sourceCode sh"><code class="sourceCode bash"><span class="bu">cd</span> ~/efs/<span class="va">${PROJECT_NAME}</span>/workspace/software/cytominer_scripts

<span class="ex">aws</span> s3 sync --exclude <span class="st">&quot;*.sqlite&quot;</span> \
  s3://<span class="va">${BUCKET}</span>/projects/<span class="va">${PROJECT_NAME}</span>/workspace/backend/<span class="va">${BATCH_ID}</span>/ \
  ~/efs/<span class="va">${PROJECT_NAME}</span>/workspace/backend/<span class="va">${BATCH_ID}</span>/

<span class="fu">rsync</span> -arzv ~/ebs_tmp/<span class="va">${PROJECT_NAME}</span>/workspace/log/ ../../log</code></pre></div>
</div>
<div id="quick-check-rows" class="section level3">
<h3><span class="header-section-number">6.2.2</span> Quick Check Rows</h3>
<p>Do a quick check to view how many rows are present in each of the aggregated per-well data.</p>
<div class="sourceCode"><pre class="sourceCode sh"><code class="sourceCode bash"><span class="ex">parallel</span> \
  --no-run-if-empty \
  --keep-order \
  wc -l ../../backend/<span class="va">${BATCH_ID}</span>/<span class="dt">{1}/{1}</span>.csv :::: <span class="va">${PLATES}</span></code></pre></div>
</div>
<div id="something-amiss" class="section level3">
<h3><span class="header-section-number">6.2.3</span> Something Amiss?</h3>
<p>Check the error logs.</p>
<div class="sourceCode"><pre class="sourceCode sh"><code class="sourceCode bash"><span class="va">step=</span>collate
<span class="ex">parallel</span> \
  --no-run-if-empty \
  --keep-order \
  head ../../log/<span class="va">${BATCH_ID}</span>/<span class="va">${step}</span>/1/<span class="dt">{1}</span>/stderr :::: <span class="va">${PLATES}</span></code></pre></div>
</div>
</div>
<div id="annotate" class="section level2">
<h2><span class="header-section-number">6.3</span> Annotate</h2>
<p>First, get metadata for the plates. This should be created beforehand and be made available in S3.</p>
<p>We use <a href="https://github.com/broadinstitute/cytominer_scripts/blob/master/annotate.R">annotate.R</a> for this procedure.</p>
<div class="sourceCode"><pre class="sourceCode sh"><code class="sourceCode bash"><span class="ex">aws</span> s3 sync \
  s3://<span class="va">${BUCKET}</span>/projects/<span class="va">${PROJECT_NAME}</span>/workspace/metadata/<span class="va">${BATCH_ID}</span>/ \
  ~/efs/<span class="va">${PROJECT_NAME}</span>/workspace/metadata/<span class="va">${BATCH_ID}</span>/</code></pre></div>
<p>This is the resulting structure of the metadata folder on EFS (one level below <code>workspace</code>): Be super careful about matching names!</p>
<pre><code>└── metadata
    └── 2016_04_01_a549_48hr_batch1
        ├── barcode_platemap.csv
        └── platemap
            └── C-7161-01-LM6-006.txt</code></pre>
<p><code>2016_04_01_a549_48hr_batch1</code> is the batch name – the plates (and all related data) are arranged under batches, as seen below.</p>
<p><code>barcode_platemap.csv</code> is structured as shown below. <code>Assay_Plate_Barcode</code> and <code>Plate_Map_Name</code> are currently the only mandatory columns (they are used to join the metadata of the plate map with each assay plate). Each unique entry in the <code>Plate_Map_Name</code> should have a corresponding tab-separated file <code>.txt</code> file under <code>platemap</code> (e.g. <code>C-7161-01-LM6-006.txt</code>).</p>
<pre><code>Assay_Plate_Barcode,Plate_Map_Name
SQ00015167,C-7161-01-LM6-006</code></pre>
<p>The tab-separated files are plate maps and are structured like this: (This is the typical format followed by Broad Chemical Biology Platform)</p>
<pre><code>plate_map_name  well_position broad_sample  mg_per_ml mmoles_per_liter  solvent
C-7161-01-LM6-006 A07 BRD-K18895904-001-16-1  3.12432000000000016 9.99999999999999999 DMSO
C-7161-01-LM6-006 A08 BRD-K18895904-001-16-1  1.04143999999919895 3.33333333333076923 DMSO
C-7161-01-LM6-006 A09 BRD-K18895904-001-16-1  0.347146666668001866  1.11111111111538462 DMSO</code></pre>

<div class="rmdnote">
<ul>
<li><code>plate_map_name</code> should be identical to the name of the file (without extension).</li>
<li><code>plate_map_name</code> and <code>well_position</code> are currently the only mandatory columns.</li>
<li>If your experiment has two or more cell lines, but the same plate map, create one plate map file for each cell line, e.g. <code>C-7161-01-LM6-006_A549.txt</code>, rename the <code>plate_map_name</code> to the name of the file without extension (e.g. <code>C-7161-01-LM6-006_A549</code>), add a column <code>cell_id</code>, and populate it with the name of the cell line (e.g. <code>A549</code>). Make sure the plate maps for all lines are reflected in the <code>barcode_platemap.csv</code> file.
</div>
</li>
</ul>
<p>Next, append the metadata to the aggregated per-well data.</p>
<div id="example-1-simple-metadata" class="section level3">
<h3><span class="header-section-number">6.3.1</span> Example 1: Simple Metadata</h3>
<div class="sourceCode"><pre class="sourceCode sh"><code class="sourceCode bash"><span class="bu">cd</span>  ~/efs/<span class="va">${PROJECT_NAME}</span>/workspace/software/cytominer_scripts

<span class="ex">parallel</span> \
  --no-run-if-empty \
  --eta \
  --joblog ../../log/<span class="va">${BATCH_ID}</span>/annotate.log \
  --results ../../log/<span class="va">${BATCH_ID}</span>/annotate \
  --files \
  --keep-order \
  ./annotate.R \
  --batch_id <span class="va">${BATCH_ID}</span> \
  --plate_id <span class="dt">{1}</span> :::: <span class="va">${PLATES}</span></code></pre></div>
</div>
<div id="example-2-complex-metadata" class="section level3">
<h3><span class="header-section-number">6.3.2</span> Example 2: Complex Metadata</h3>
<p>This is an example coming from Broad chemical experiment.</p>

<div class="rmdnote">
<p>Use the <code>-j</code> flag to optionally append columns from another source (<code>EXTERNAL_METADATA</code> below). <code>EXTERNAL_METADATA</code> should be a CSV file. The columns that are in common with the aggregated CSV file will be used to join. See the <code>annotate</code> <a href="https://github.com/broadinstitute/cytominer_scripts/blob/master/annotate.R">source</a> for details.</p>
Use the <code>-c</code> flag to optionally specify the cell type.
</div>

<div class="sourceCode"><pre class="sourceCode sh"><code class="sourceCode bash"><span class="bu">cd</span>  ~/efs/<span class="va">${PROJECT_NAME}</span>/workspace/software/cytominer_scripts

<span class="va">EXTERNAL_METADATA=</span>../../metadata/<span class="va">${BATCH_ID}</span>/cell_painting_dataset_cmap_annotations_moa.csv

<span class="ex">parallel</span> \
  --no-run-if-empty \
  --eta \
  --joblog ../../log/<span class="va">${BATCH_ID}</span>/annotate.log \
  --results ../../log/<span class="va">${BATCH_ID}</span>/annotate \
  --files \
  --keep-order \
  ./annotate.R \
  --batch_id <span class="va">${BATCH_ID}</span> \
  --plate_id <span class="dt">{1}</span> \
  --format_broad_cmap \
  --cell_id A549 \
  --external_metadata <span class="va">${EXTERNAL_METADATA}</span> \
  --perturbation_mode chemical :::: <span class="va">${PLATES}</span></code></pre></div>
</div>
<div id="expected-folder-structure" class="section level3">
<h3><span class="header-section-number">6.3.3</span> Expected Folder Structure</h3>
<p>This is the resulting structure of <code>backend</code> on EFS (one level below <code>workspace</code>) for <code>SQ00015167</code>:</p>
<pre><code>└── backend
    └── 2016_04_01_a549_48hr_batch1
        └── SQ00015167
            ├── SQ00015167_augmented.csv
            └── SQ00015167.csv</code></pre>
<p><code>SQ00015167_augmented.csv</code> is the aggregated per-well data, annotated with metadata.</p>
</div>
<div id="quick-check-rows-1" class="section level3">
<h3><span class="header-section-number">6.3.4</span> Quick Check Rows</h3>
<p>Do a quick check to view how many rows are present in each of the annotated per-well data.</p>
<div class="sourceCode"><pre class="sourceCode sh"><code class="sourceCode bash"><span class="ex">parallel</span> \
  --no-run-if-empty \
  --keep-order \
  wc -l ../../backend/<span class="va">${BATCH_ID}</span>/<span class="dt">{1}/{1}</span>_augmented.csv :::: <span class="va">${PLATES}</span></code></pre></div>
</div>
<div id="something-amiss-1" class="section level3">
<h3><span class="header-section-number">6.3.5</span> Something Amiss?</h3>
<p>Check the error logs.</p>
<div class="sourceCode"><pre class="sourceCode sh"><code class="sourceCode bash"><span class="va">step=</span>annotate
<span class="ex">parallel</span> \
  --no-run-if-empty \
  --keep-order \
  head ../../log/<span class="va">${BATCH_ID}</span>/<span class="va">${step}</span>/1/<span class="dt">{1}</span>/stderr :::: <span class="va">${PLATES}</span></code></pre></div>
</div>
</div>
<div id="normalize" class="section level2">
<h2><span class="header-section-number">6.4</span> Normalize</h2>
<p>Use all wells on the plate to normalize each feature. By default, this performs robust z-scoring per feature. The default input is the annotated per-well data. The column picked for normalization (e.g. &quot;Metadata_Well&quot;) needs to be present in the CSV; if it was added in the augmentation step (e.g. &quot;cell_id&quot;) it will now have the prefix &quot;Metadata&quot; prepended to it)</p>
<p>We use <a href="https://github.com/broadinstitute/cytominer_scripts/blob/master/normalize.R">normalize.R</a> for this procedure.</p>
<div class="sourceCode"><pre class="sourceCode sh"><code class="sourceCode bash"><span class="ex">parallel</span> \
  --no-run-if-empty \
  --eta \
  --joblog ../../log/<span class="va">${BATCH_ID}</span>/normalize.log \
  --results ../../log/<span class="va">${BATCH_ID}</span>/normalize \
  --files \
  --keep-order \
  ./normalize.R \
  --batch_id <span class="va">${BATCH_ID}</span> \
  --plate_id <span class="dt">{1}</span> \
  --subset <span class="dt">\&quot;</span>Metadata_Well != <span class="dt">\&#39;\&#39;\&#39;</span>dummy<span class="dt">\&#39;\&#39;\&#39;\&quot;</span> :::: <span class="va">${PLATES}</span></code></pre></div>

<div class="rmdnote">
<ul>
<li>Don't escape quotes if not using parallel i.e. use <code>--subset &quot;Metadata_Well != '''dummy'''&quot;</code> if not using within parallel.</li>
<li>To use a different reference distribution to compute the median and m.a.d. for z-scoring, change the filter specified using the <code>--subset</code> flag.
</div>
</li>
</ul>
<div id="expected-folder-structure-1" class="section level3">
<h3><span class="header-section-number">6.4.1</span> Expected Folder Structure</h3>
<p>This is the resulting structure of <code>backend</code> on EFS (one level below <code>workspace</code>) for <code>SQ00015167</code>:</p>
<pre><code>└── backend
    └── 2016_04_01_a549_48hr_batch1
        └── SQ00015167
            ├── SQ00015167_augmented.csv
            ├── SQ00015167.csv
            └── SQ00015167_normalized.csv</code></pre>
<p><code>SQ00015167_normalized.csv</code> is the robust z-scored (normalized) per-well data.</p>
</div>
<div id="quick-check-rows-2" class="section level3">
<h3><span class="header-section-number">6.4.2</span> Quick Check Rows</h3>
<p>Do a quick check to view how many rows are present in each of the normalized per-well data.</p>
<div class="sourceCode"><pre class="sourceCode sh"><code class="sourceCode bash"><span class="ex">parallel</span> \
  --no-run-if-empty \
  --keep-order \
  wc -l ../../backend/<span class="va">${BATCH_ID}</span>/<span class="dt">{1}/{1}</span>_normalized.csv :::: <span class="va">${PLATES}</span></code></pre></div>
</div>
<div id="something-amiss-2" class="section level3">
<h3><span class="header-section-number">6.4.3</span> Something Amiss?</h3>
<p>Check the error logs.</p>
<div class="sourceCode"><pre class="sourceCode sh"><code class="sourceCode bash"><span class="va">step=</span>normalize
<span class="ex">parallel</span> \
  --no-run-if-empty \
  --keep-order \
  head ../../log/<span class="va">${BATCH_ID}</span>/<span class="va">${step}</span>/1/<span class="dt">{1}</span>/stderr :::: <span class="va">${PLATES}</span></code></pre></div>
</div>
</div>
<div id="select-variables" class="section level2">
<h2><span class="header-section-number">6.5</span> Select Variables</h2>
<p>Create samples to do variable selection. Sample some wells from each replicate plate (if your experiment contains multiple copies of identical plates). Below, this is done by sample 2 entire replicate plates per platemap. Use <code>-n</code> (<code>--replicates</code>) to specify number of replicate <strong>plates</strong> to be used to create the sample (if you don't have identical replicate plates in your experiment, you can set this to 1).</p>
<div id="sample-data" class="section level3">
<h3><span class="header-section-number">6.5.1</span> Sample Data</h3>
<p>Samples are created for both, normalized and unnormalized data, because the variable selection techniques may require both.</p>
<p>We use <a href="https://github.com/broadinstitute/cytominer_scripts/blob/master/sample.R">sample.R</a> for this procedure.</p>
<div class="sourceCode"><pre class="sourceCode sh"><code class="sourceCode bash"><span class="fu">mkdir</span> -p ../../parameters/<span class="va">${BATCH_ID}</span>/sample/

<span class="co"># sample normalized data</span>
<span class="ex">./sample.R</span> \
  --batch_id <span class="va">${BATCH_ID}</span> \
  --pattern <span class="st">&quot;_normalized.csv$&quot;</span> \
  --replicates 2 \
  --output ../../parameters/<span class="va">${BATCH_ID}</span>/sample/<span class="va">${BATCH_ID}</span>_normalized_sample.feather

<span class="co"># sample unnormalized data</span>
<span class="ex">./sample.R</span> \
  --batch_id <span class="va">${BATCH_ID}</span> \
  --pattern <span class="st">&quot;_augmented.csv$&quot;</span> \
  --replicates 2 \
  --output ../../parameters/<span class="va">${BATCH_ID}</span>/sample/<span class="va">${BATCH_ID}</span>_augmented_sample.feather</code></pre></div>
</div>
<div id="preselect" class="section level3">
<h3><span class="header-section-number">6.5.2</span> Preselect</h3>
<p>We use <a href="https://github.com/broadinstitute/cytominer_scripts/blob/master/preselect.R">preselect.R</a> for these procedures.</p>
<div id="replicate-correlation" class="section level4">
<h4><span class="header-section-number">6.5.2.1</span> Replicate Correlation</h4>
<p>Make a list of variables to be preserved after <a href="https://cytomining.github.io/cytominer/reference/replicate_correlation.html"><code>replicate_correlation</code></a> variable selection is performed. If you don't have replicate <strong>plates</strong> in this experiment, skip this step.</p>
<p>To evaluate features for their replicability, use all the normalized profiles of treatments in the experiment (selected below using <code>Metadata_broad_sample_type == 'trt'</code>).</p>
<div class="sourceCode"><pre class="sourceCode sh"><code class="sourceCode bash"><span class="ex">./preselect.R</span> \
  --batch_id <span class="va">${BATCH_ID}</span> \
  --input ../../parameters/<span class="va">${BATCH_ID}</span>/sample/<span class="va">${BATCH_ID}</span>_normalized_sample.feather \
  --operations replicate_correlation \
  --subset <span class="st">&quot;Metadata_broad_sample_type == &#39;&#39;&#39;trt&#39;&#39;&#39;&quot;</span> \
  --replicates 2</code></pre></div>
</div>
<div id="correlation-threshold" class="section level4">
<h4><span class="header-section-number">6.5.2.2</span> Correlation Threshold</h4>
<p>Make a list of variables to be preserved after <a href="https://cytomining.github.io/cytominer/reference/correlation_threshold.html"><code>correlation_threshold</code></a> variable selection is performed.</p>
<div class="sourceCode"><pre class="sourceCode sh"><code class="sourceCode bash"><span class="ex">./preselect.R</span> \
  --batch_id <span class="va">${BATCH_ID}</span> \
  --input ../../parameters/<span class="va">${BATCH_ID}</span>/sample/<span class="va">${BATCH_ID}</span>_normalized_sample.feather \
  --operations correlation_threshold</code></pre></div>
</div>
<div id="variance-threshold" class="section level4">
<h4><span class="header-section-number">6.5.2.3</span> Variance Threshold</h4>
<p>Make a list of variables to be preserved after <a href="https://cytomining.github.io/cytominer/reference/variance_threshold.html"><code>variance_threshold</code></a> variable selection is performed.</p>
<p>To evaluate the variance of features, use only the control wells the experiment (selected below using <code>Metadata_broad_sample_type == 'control'</code>).</p>
<div class="sourceCode"><pre class="sourceCode sh"><code class="sourceCode bash"><span class="ex">./preselect.R</span> \
  --batch_id <span class="va">${BATCH_ID}</span> \
  --input ../../parameters/<span class="va">${BATCH_ID}</span>/sample/<span class="va">${BATCH_ID}</span>_augmented_sample.feather \
  --operations variance_threshold \
  --subset <span class="st">&quot;Metadata_broad_sample_type == &#39;&#39;&#39;control&#39;&#39;&#39;&quot;</span></code></pre></div>
</div>
<div id="noise-threshold" class="section level4">
<h4><span class="header-section-number">6.5.2.4</span> Noise Threshold</h4>
<p>Some variables have previously identified as being noisy or non-informative. Create a list of variables that excludes these variables.</p>
<div class="sourceCode"><pre class="sourceCode sh"><code class="sourceCode bash"><span class="co"># manually remove some features</span>
<span class="bu">echo</span> <span class="st">&quot;variable&quot;</span> <span class="op">&gt;</span> ../../parameters/<span class="va">${BATCH_ID}</span>/variable_selection/manual.txt

<span class="fu">head</span> -1 \
  ../../backend/<span class="va">${BATCH_ID}</span>/<span class="va">${SAMPLE_PLATE_ID}</span>/<span class="va">${SAMPLE_PLATE_ID}</span>.csv \
  <span class="kw">|</span><span class="fu">tr</span> <span class="st">&quot;,&quot;</span> <span class="st">&quot;\n&quot;</span><span class="kw">|</span><span class="fu">grep</span> -v Meta<span class="kw">|</span><span class="fu">grep</span> -E -v <span class="st">&#39;Granularity_14|Granularity_15|Granularity_16|Manders|RWC|Costes&#39;</span> <span class="op">&gt;&gt;</span> \
  ../../parameters/<span class="va">${BATCH_ID}</span>/variable_selection/manual.txt</code></pre></div>
</div>
</div>
<div id="alternate-load-previous-preselect-configuration" class="section level3">
<h3><span class="header-section-number">6.5.3</span> Alternate: Load previous preselect configuration</h3>
<p>You may have already performed these steps for a different batch of data, and want to simply copy the parameters to this batch. Here's how you'd copy these files.</p>
<div class="sourceCode"><pre class="sourceCode sh"><code class="sourceCode bash"><span class="fu">mkdir</span> -p ../../parameters/<span class="va">${BATCH_ID}</span>/variable_selection/

<span class="va">REFERENCE_BATCH_ID=</span>2018_02_23_LKCP_DBG

<span class="ex">aws</span> s3 sync \
  s3://<span class="va">${BUCKET}</span>/projects/<span class="va">${PROJECT_NAME}</span>/workspace/parameters/<span class="va">${REFERENCE_BATCH_ID}</span>/ \
  ~/efs/<span class="va">${PROJECT_NAME}</span>/workspace/parameters/<span class="va">${REFERENCE_BATCH_ID}</span>/

<span class="fu">rsync</span> -arzv ../../parameters/<span class="va">${REFERENCE_BATCH_ID}</span>/variable_selection/ ../../parameters/<span class="va">${BATCH_ID}</span>/variable_selection/</code></pre></div>
</div>
</div>
<div id="execute-feature-selection" class="section level2">
<h2><span class="header-section-number">6.6</span> Execute Feature Selection</h2>
<p>We use <a href="https://github.com/broadinstitute/cytominer_scripts/blob/master/select.R">select.R</a> for this procedures.</p>
<p>The previous steps only create a list of variable to be preserved for each variable selection method. To actually apply variable selection, we compute the intersection of all these variable lists, then preserve only those columns of the normalized per-well data. In the <code>filters</code> argument, exclude the variable selection methods that you do not want to use.</p>
<div class="sourceCode"><pre class="sourceCode sh"><code class="sourceCode bash"><span class="ex">parallel</span> \
  --no-run-if-empty \
  --eta \
  --joblog ../../log/<span class="va">${BATCH_ID}</span>/select.log \
  --results ../../log/<span class="va">${BATCH_ID}</span>/select \
  --files \
  --keep-order \
  ./select.R \
  --batch_id <span class="va">${BATCH_ID}</span> \
  --plate_id <span class="dt">{1}</span> \
  --filters variance_threshold,replicate_correlation,correlation_threshold,manual :::: <span class="va">${PLATES}</span></code></pre></div>
<div id="expected-folder-structure-2" class="section level3">
<h3><span class="header-section-number">6.6.1</span> Expected Folder Structure</h3>
<p>This is the resulting structure of <code>backend</code> on EFS (one level below <code>workspace</code>) for <code>SQ00015167</code>:</p>
<pre><code>└── backend
    └── 2016_04_01_a549_48hr_batch1
        └── SQ00015167
            ├── SQ00015167_augmented.csv
            ├── SQ00015167.csv
            ├── SQ00015167_normalized.csv
            └── SQ00015167_normalized_variable_selected.csv</code></pre>
<p><code>SQ00015167_normalized_variable_selected.csv</code> is the variable-selected version of the normalized per-well data.</p>
</div>
<div id="quick-check-rows-3" class="section level3">
<h3><span class="header-section-number">6.6.2</span> Quick Check Rows</h3>
<p>Do a quick check to view how many rows are present in each of the normalized per-well data.</p>
<div class="sourceCode"><pre class="sourceCode sh"><code class="sourceCode bash"><span class="ex">parallel</span> \
  --no-run-if-empty \
  --keep-order \
  wc -l ../../backend/<span class="va">${BATCH_ID}</span>/<span class="dt">{1}/{1}</span>_normalized_variable_selected.csv :::: <span class="va">${PLATES}</span></code></pre></div>
</div>
<div id="something-amiss-3" class="section level3">
<h3><span class="header-section-number">6.6.3</span> Something Amiss?</h3>
<p>Check the error logs.</p>
<div class="sourceCode"><pre class="sourceCode sh"><code class="sourceCode bash"><span class="va">step=</span>select
<span class="ex">parallel</span> \
  --no-run-if-empty \
  --keep-order \
  head ../../log/<span class="va">${BATCH_ID}</span>/<span class="va">${step}</span>/1/<span class="dt">{1}</span>/stderr :::: <span class="va">${PLATES}</span></code></pre></div>
</div>
</div>
<div id="aggregate-replicates" class="section level2">
<h2><span class="header-section-number">6.7</span> Aggregate Replicates</h2>
<p>Combine replicate plates of each plate map by <a href="https://github.com/broadinstitute/cytominer_scripts/blob/master/collapse.R">averaging</a> (default is mean).</p>
<div class="sourceCode"><pre class="sourceCode sh"><code class="sourceCode bash"><span class="fu">mkdir</span> -p ../../collated/<span class="va">${BATCH_ID}</span>/

<span class="va">PLATE_MAPS=</span>../../scratch/<span class="va">${BATCH_ID}</span>/plate_maps.txt

<span class="ex">csvcut</span> -c Plate_Map_Name \
  ../../metadata/<span class="va">${BATCH_ID}</span>/barcode_platemap.csv <span class="kw">|</span> <span class="kw">\</span>
  <span class="fu">tail</span> -n +2<span class="kw">|</span><span class="fu">sort</span><span class="kw">|</span><span class="fu">uniq</span> <span class="op">&gt;</span> \
  <span class="va">${PLATE_MAPS}</span>

<span class="ex">parallel</span> \
  --no-run-if-empty \
  --eta \
  --joblog ../../log/<span class="va">${BATCH_ID}</span>/collapse.log \
  --results ../../log/<span class="va">${BATCH_ID}</span>/collapse \
  --keep-order \
  ./collapse.R \
  --batch_id <span class="va">${BATCH_ID}</span> \
  --plate_map_name <span class="dt">{1}</span> \
  --suffix _normalized_variable_selected.csv \
  --output ../../collated/<span class="va">${BATCH_ID}</span>/<span class="dt">{1}</span>_collapsed.csv :::: <span class="va">${PLATE_MAPS}</span></code></pre></div>
<div id="expected-folder-structure-3" class="section level3">
<h3><span class="header-section-number">6.7.1</span> Expected Folder Structure</h3>
<p>This is the resulting structure of <code>collated</code> on EFS (one level below <code>workspace</code>) for <code>2016_04_01_a549_48hr_batch1</code>:</p>
<pre><code>└── collated
    └── 2016_04_01_a549_48hr_batch1
        └── C-7161-01-LM6-006_collapsed.csv</code></pre>
<p><code>C-7161-01-LM6-006_collapsed.csv</code> is the replicate averaged data for plate map <code>C-7161-01-LM6-006</code>.</p>
</div>
<div id="quick-check-rows-4" class="section level3">
<h3><span class="header-section-number">6.7.2</span> Quick Check Rows</h3>
<p>Do a quick check to view how many rows are present in the replicate averaged data of each plate map.</p>
<div class="sourceCode"><pre class="sourceCode sh"><code class="sourceCode bash"><span class="ex">parallel</span> \
  --no-run-if-empty \
  --keep-order \
  wc -l ../../collated/<span class="va">${BATCH_ID}</span>/<span class="dt">{1}</span>_collapsed.csv :::: <span class="va">${PLATE_MAPS}</span></code></pre></div>
</div>
<div id="combine-averaged-profiles" class="section level3">
<h3><span class="header-section-number">6.7.3</span> Combine Averaged Profiles</h3>
<p>Combine all averaged profiles in the batch into a single file.</p>
<div class="sourceCode"><pre class="sourceCode sh"><code class="sourceCode bash"><span class="ex">csvstack</span> \
  <span class="kw">`</span><span class="ex">parallel</span> echo ../../collated/<span class="va">${BATCH_ID}</span>/<span class="dt">{1}</span>_collapsed.csv :::: <span class="va">${PLATE_MAPS}</span><span class="kw">`</span> <span class="op">&gt;</span> \
   ../../collated/<span class="va">${BATCH_ID}</span>/<span class="va">${BATCH_ID}</span>_collapsed.csv</code></pre></div>
</div>
</div>
<div id="audit" class="section level2">
<h2><span class="header-section-number">6.8</span> Audit</h2>
<p>Audit each plate map for replicate reproducibility. We use <a href="https://github.com/broadinstitute/cytominer_scripts/blob/master/audit.R">audit.R</a> for these procedures. This will only work if your experiment contains multiple copies of identical <strong>plates</strong>; if it does not, you may skip this step.</p>
<div class="sourceCode"><pre class="sourceCode sh"><code class="sourceCode bash"><span class="fu">mkdir</span> -p ../../audit/<span class="va">${BATCH_ID}</span>/</code></pre></div>
<div id="treatment-audit" class="section level3">
<h3><span class="header-section-number">6.8.1</span> Treatment Audit</h3>
<p>Audit only treated wells</p>
<div class="sourceCode"><pre class="sourceCode sh"><code class="sourceCode bash"><span class="ex">parallel</span> \
  --no-run-if-empty \
  --eta \
  --joblog ../../log/<span class="va">${BATCH_ID}</span>/audit.log \
  --results ../../log/<span class="va">${BATCH_ID}</span>/audit \
  --files \
  --keep-order \
  ./audit.R \
  --batch_id <span class="va">${BATCH_ID}</span> \
  --plate_map_name <span class="dt">{1}</span> \
  --suffix _normalized_variable_selected.csv \
  --subset <span class="dt">\&quot;</span>Metadata_broad_sample_type == <span class="dt">\&#39;\&#39;\&#39;</span>trt<span class="dt">\&#39;\&#39;\&#39;\&quot;</span> \
  --output ../../audit/<span class="va">${BATCH_ID}</span>/<span class="dt">{1}</span>_audit.csv \
  --output_detailed ../../audit/<span class="va">${BATCH_ID}</span>/<span class="dt">{1}</span>_audit_detailed.csv \
  --group_by Metadata_Plate_Map_Name,Metadata_moa,Metadata_pert_id,Metadata_broad_sample,Metadata_mmoles_per_liter,Metadata_Well :::: <span class="va">${PLATE_MAPS}</span></code></pre></div>
</div>
<div id="control-audit" class="section level3">
<h3><span class="header-section-number">6.8.2</span> Control Audit</h3>
<p>Audit only control wells, i.e., how well do control wells in the same position correlate?</p>
<div class="sourceCode"><pre class="sourceCode sh"><code class="sourceCode bash"><span class="ex">parallel</span> \
  --no-run-if-empty \
  --eta \
  --joblog ../../log/<span class="va">${BATCH_ID}</span>/audit_control.log \
  --results ../../log/<span class="va">${BATCH_ID}</span>/audit_control \
  --files \
  --keep-order \
  ./audit.R \
  --batch_id <span class="va">${BATCH_ID}</span> \
  --plate_map_name <span class="dt">{1}</span> \
  --suffix _normalized_variable_selected.csv \
  --subset <span class="dt">\&quot;</span>Metadata_broad_sample_type == <span class="dt">\&#39;\&#39;\&#39;</span>control<span class="dt">\&#39;\&#39;\&#39;\&quot;</span> \
  --output ../../audit/<span class="va">${BATCH_ID}</span>/<span class="dt">{1}</span>_audit_control.csv \
  --output_detailed ../../audit/<span class="va">${BATCH_ID}</span>/<span class="dt">{1}</span>_audit_control_detailed.csv \
  --group_by Metadata_Well :::: <span class="va">${PLATE_MAPS}</span></code></pre></div>
</div>
</div>
<div id="convert-to-other-formats" class="section level2">
<h2><span class="header-section-number">6.9</span> Convert to Other Formats</h2>
<p>We use <a href="https://github.com/broadinstitute/cytominer_scripts/blob/master/csv2gct.R">csv2gct.R</a> for these procedures.</p>
<p>These GCT files can be examined in many programs, though we routinely use <a href="https://software.broadinstitute.org/morpheus/">Morpheus</a>.</p>
<div id="convert-per-plate-csv-files-to-gct" class="section level3">
<h3><span class="header-section-number">6.9.1</span> Convert per-plate CSV files to GCT</h3>
<div class="sourceCode"><pre class="sourceCode sh"><code class="sourceCode bash"><span class="ex">parallel</span> \
  --no-run-if-empty \
  --eta \
  --joblog ../../log/<span class="va">${BATCH_ID}</span>/csv2gct_backend.log \
  --results ../../log/<span class="va">${BATCH_ID}</span>/csv2gct_backend \
  --files \
  --keep-order \
  ./csv2gct.R \
  ../../backend/<span class="va">${BATCH_ID}</span>/<span class="dt">{1}/{1}_{2}</span>.csv \
  --output ../../backend/<span class="va">${BATCH_ID}</span>/<span class="dt">{1}/{1}_{2}</span>.gct :::: <span class="va">${PLATES}</span> ::: augmented normalized normalized_variable_selected</code></pre></div>
</div>
<div id="convert-per-plate-map-csv-files-to-gct" class="section level3">
<h3><span class="header-section-number">6.9.2</span> Convert per-plate map CSV files to GCT</h3>
<div class="sourceCode"><pre class="sourceCode sh"><code class="sourceCode bash"><span class="ex">parallel</span> \
  --no-run-if-empty \
  --eta \
  --joblog ../../log/<span class="va">${BATCH_ID}</span>/csv2gct_collapsed.log \
  --results ../../log/<span class="va">${BATCH_ID}</span>/csv2gct_collapsed \
  --files \
  --keep-order \
  ./csv2gct.R \
  ../../collated/<span class="va">${BATCH_ID}</span>/<span class="dt">{1}</span>_collapsed.csv \
  --output ../../collated/<span class="va">${BATCH_ID}</span>/<span class="dt">{1}</span>_collapsed.gct :::: <span class="va">${PLATE_MAPS}</span></code></pre></div>
</div>
<div id="convert-the-replicate-collapsed-csv-file-to-gct" class="section level3">
<h3><span class="header-section-number">6.9.3</span> Convert the replicate-collapsed CSV file to gct</h3>
<div class="sourceCode"><pre class="sourceCode sh"><code class="sourceCode bash"><span class="ex">./csv2gct.R</span> \
  ../../collated/<span class="va">${BATCH_ID}</span>/<span class="va">${BATCH_ID}</span>_collapsed.csv \
  --output ../../collated/<span class="va">${BATCH_ID}</span>/<span class="va">${BATCH_ID}</span>_collapsed.gct</code></pre></div>
</div>
</div>
<div id="upload-data" class="section level2">
<h2><span class="header-section-number">6.10</span> Upload Data</h2>
<div id="sync-to-s3" class="section level3">
<h3><span class="header-section-number">6.10.1</span> Sync to S3</h3>
<div class="sourceCode"><pre class="sourceCode sh"><code class="sourceCode bash"><span class="ex">parallel</span> \
  aws s3 sync \
    ../../<span class="dt">{1}/${BATCH_ID}</span>/ \
    s3://<span class="va">${BUCKET}</span>/projects/<span class="va">${PROJECT_NAME}</span>/workspace/<span class="dt">{1}/${BATCH_ID}</span>/ ::: audit backend batchfiles collated load_data_csv log metadata parameters scratch</code></pre></div>
</div>
<div id="sync-down-from-s3-onto-a-machine" class="section level3">
<h3><span class="header-section-number">6.10.2</span> Sync Down from S3 onto a Machine</h3>
<p>Specify location for syncing</p>
<div class="sourceCode"><pre class="sourceCode sh"><code class="sourceCode bash"><span class="va">LOCAL_FS=</span>/cmap/imaging</code></pre></div>
<p>Set variables on your local machine matching those set on your EC2 instance</p>
<div class="sourceCode"><pre class="sourceCode sh"><code class="sourceCode bash"><span class="va">PROJECT_NAME=</span>2015_10_05_DrugRepurposing_AravindSubramanian_GolubLab_Broad

<span class="va">BATCH_ID=</span>2016_04_01_a549_48hr_batch1</code></pre></div>
</div>
<div id="sync-the-files" class="section level3">
<h3><span class="header-section-number">6.10.3</span> Sync the files</h3>
<div class="sourceCode"><pre class="sourceCode sh"><code class="sourceCode bash"><span class="bu">echo</span> audit backend batchfiles collated load_data_csv log metadata parameters scratch <span class="kw">|</span> <span class="kw">\</span>
  <span class="fu">tr</span> <span class="st">&quot; &quot;</span> <span class="st">&quot;\n&quot;</span> <span class="kw">|</span>
  <span class="fu">xargs</span> -I % \
  aws s3 sync \
    --exclude <span class="st">&quot;*.sqlite&quot;</span> \
    s3://<span class="va">${BUCKET}</span>/projects/<span class="va">${PROJECT_NAME}</span>/workspace/%/<span class="va">${BATCH_ID}</span>/ \
    <span class="va">${LOCAL_FS}</span>/<span class="va">${PROJECT_NAME}</span>/workspace/%/<span class="va">${BATCH_ID}</span>/</code></pre></div>

</div>
</div>
</div>



            </section>

          </div>
        </div>
      </div>
<a href="run-jobs.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="appendix-a.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/lunr.js"></script>
<script src="libs/gitbook-2.6.7/js/clipboard.min.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-clipboard.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": false,
"facebook": true,
"twitter": true,
"linkedin": false,
"weibo": false,
"instapaper": false,
"vk": false,
"all": ["facebook", "twitter", "linkedin", "weibo", "instapaper"]
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": "https://github.com/cytomining/profiling-handbook/edit/master/06-create-profiles.Rmd",
"text": "Edit"
},
"history": {
"link": null,
"text": null
},
"view": {
"link": null,
"text": null
},
"download": ["bookdown-demo.pdf", "bookdown-demo.epub"],
"toc": {
"collapse": "subsection"
}
});
});
</script>

</body>

</html>
